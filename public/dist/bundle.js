!function(e){var t={};function r(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(s,o,function(t){return e[t]}.bind(null,o));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";function s(e,t,r){const s=e.elements[t],o=document.createElement("p");o.setAttribute("style","margin: 0;"),o.innerText=r,s.nextElementSibling.appendChild(o)}function o(e){const t=e.getElementsByClassName("error-msg");Array.prototype.forEach.call(t,e=>{e.innerHTML=""})}r.r(t);class i{constructor(e){if(!(e instanceof Node))throw new TypeError("rootEl must be Node");this._rootEl=e,this._routeMakerFns={},this._defaultRoutePath=null,this._currentRoute=null,this.notFoundRouteMaker=null}addRoute(e,t){"string"==typeof e&&"function"==typeof t&&(this._routeMakerFns[e]=t)}setDefaultRoute(e){"string"==typeof e&&(this._defaultRoutePath=e)}init(){this.routeTo(this._defaultRoutePath,!1)}routeTo(e,t=!0){if("string"!=typeof e)return;t?(console.log("Pushing",e),history.pushState(null,null,e)):console.log("Poping",e),this._currentRoute&&(this._currentRoute.deinit&&this._currentRoute.deinit(),this._currentRoute=null);let r=this._routeMakerFns[e];r||(console.log("OI MATE"),r=this.notFoundRouteMaker);const s=r(this._rootEl,this);s&&(this._currentRoute=s,s.init&&s.init())}}Handlebars.registerHelper("pagination",function(e,t,r,s){let o,i;3===arguments.length&&(s=r,r=5),o=e-Math.floor(r/2),i=e+Math.floor(r/2),o<=0&&(i-=o-1,o=1),i>t&&(o=(i=t)-r+1>0?i-r+1:1);const n={startFromFirstPage:!1,pages:[],endAtLastPage:!1};1===o&&(n.startFromFirstPage=!0);for(let t=o;t<=i;t++)n.pages.push({page:t,isCurrent:t===e});return i===t&&(n.endAtLastPage=!0),s.fn(n)});class n{constructor(e,t,r=null,s=null){if(!(e instanceof Node))throw new TypeError("rootEl must be Node");if(!(t instanceof i))throw new TypeError("router must be Router");this._rootEl=e,this._router=t,this._controller=r,this._subscriber=s,this._eventHandlers={},this.render&&(this._render=this.render.bind(this))}_addListener(e,t){e in this._eventHandlers||(this._eventHandlers[e]=[]),this._eventHandlers[e].push(t),this._rootEl.addEventListener(e,t)}_removeAllListeners(e){if(e in this._eventHandlers){const t=this._eventHandlers[e];for(let r=t.length;r--;){const s=t[r];this._rootEl.removeEventListener(e,s)}}}init(){}deinit(){for(event in this._rootEl.innerHTML="",this._eventHandlers)this._eventHandlers.hasOwnProperty(event)&&this._removeAllListeners(event)}}class a extends n{constructor(...e){super(...e),this._loginController=e[4],this._signupController=e[5]}render(e,t,r){e.User?this._rootEl.innerHTML=Handlebars.templates["menu.html"]({isAuthorized:!0}):r||(this._rootEl.innerHTML=Handlebars.templates["menu.html"]({isAuthorized:null}))}init(){this._addListener("submit",e=>{e.preventDefault(),this._form=e.target,o(this._form);const t=this._form.elements.login.value,r=this._form.elements.password.value;this._loginController.login(t,r)}),this._subscriber.subscribeEvent("LoggedIn",this._render),this._addListener("click",function(e){e.preventDefault();const t=document.getElementById("myBtn"),r=document.getElementById("myModal");if(e.target==r)return void(r.style.display="none");if(e.target==t)return r.style.display="block",void document.getElementById("defaultOpen").click();if("submit"==e.target.name){const e=new CustomEvent("submit");return e.initCustomEvent("submit",!0,!0),void document.forms.loginform.dispatchEvent(e)}let s,o,i;if(o=document.getElementsByClassName("tabcontent"),i=document.getElementsByClassName("tablinks"),Array.prototype.slice.call(i).includes(e.target)){for(s=0;s<o.length;s++)o[s].style.display="none";for(i=document.getElementsByClassName("tablinks"),s=0;s<i.length;s++)i[s].className=i[s].className.replace(" active","");document.getElementById(e.target.innerText).style.display="block",e.currentTarget.className+=" active"}}),this._subscriber.subscribeEvent("UserLoaded",this._render),this._controller.getUser(),super.init()}deinit(){this._subscriber.unsubscribeEvent("UserLoaded",this._render),this._rootEl.innerHTML="",super.deinit()}}class c extends n{constructor(...e){super(...e)}render(e,t,r){"success"!==r?s(this._form,r.errorField,r.error):this._router.routeTo("/")}init(){this._rootEl.innerHTML=Handlebars.templates["login.html"](),this._addListener("submit",e=>{e.preventDefault(),this._form=e.target,o(this._form);const t=this._form.elements.login.value,r=this._form.elements.password.value;this._controller.login(t,r)}),this._subscriber.subscribeEvent("LoggedIn",this._render),super.init()}deinit(){this._subscriber.unsubscribeEvent("LoggedIn",this._render),super.deinit()}}class l extends n{constructor(...e){super(...e)}render(e,t,r){"success"===r?("ProfileUpdated"===t&&(this._waitingAvatarUpdate=!1),"AvatarUpdated"===t&&(this._waitingAvatarUpdate=!1),this._waitingProfileUpdate&&this._waitingAvatarUpdate||this._router.routeTo("/")):s(this._form,r.errorField,r.error)}init(){this._rootEl.innerHTML=Handlebars.templates["settings.html"](),this._addListener("submit",e=>{e.preventDefault(),this._form=e.target,o(this._form);const t=this._form.elements.login.value,r=this._form.elements.password.value,s=this._form.elements.repeat_password.value,i=this._form.elements.avatar;i.value&&(this._waitingAvatarUpdate=!0),this._controller.updateProfile(t,r,s,i)}),this._waitingProfileUpdate=!0,this._subscriber.subscribeEvent("ProfileUpdated",this._render),this._subscriber.subscribeEvent("AvatarUpdated",this._render),super.init()}deinit(){this._subscriber.unsubscribeEvent("ProfileUpdated",this._render),this._subscriber.unsubscribeEvent("AvatarUpdated",this._render),super.deinit()}}class d extends n{constructor(...e){super(...e)}render(e,t,r){if(r){const e=r;this._rootEl.innerHTML=Handlebars.templates["profile.html"]({login:e.login,email:e.email,avatar_path:e.img,score:e.score})}else this._router.routeTo("/")}init(){this._subscriber.subscribeEvent("UserLoaded",this._render),this._controller.getUser(),super.init()}deinit(){this._subscriber.unsubscribeEvent("UserLoaded",this._render),super.deinit()}}class u extends n{constructor(...e){super(...e)}render(e,t,r){"success"!==r?s(this._form,r.errorField,r.error):this._router.routeTo("/")}init(){this._rootEl.innerHTML=Handlebars.templates["signup.html"](),this._addListener("submit",e=>{e.preventDefault(),this._form=e.target,o(this._form);const t=this._form.elements.login.value,r=this._form.elements.email.value,s=this._form.elements.password.value,i=this._form.elements.repeat_password.value;this._controller.signUp(t,r,s,i)}),this._subscriber.subscribeEvent("SignedUp",this._render),super.init()}deinit(){this._subscriber.unsubscribeEvent("SignedUp",this._render),super.deinit()}}class h extends n{constructor(...e){super(...e)}prerender(){this.render({},"",{users:[],pageCount:0,currentPage:0})}render(e,t,r){this._rootEl.innerHTML=Handlebars.templates["leaderboard.html"]({users:r.users,pageCount:r.pageCount,currentPage:r.currentPage,size:"5"}),document.getElementById("pagination").addEventListener("click",e=>{e.preventDefault();const t=e.target.getAttribute("href");this._controller.getLeaderboard(t)})}init(){this.prerender(),this._subscriber.subscribeEvent("LeaderboardLoaded",this._render),this._controller.getLeaderboard(1),super.init()}deinit(){this._subscriber.unsubscribeEvent("LeaderboardLoaded",this._render),super.deinit()}}class p extends n{constructor(e,t){super(e,t)}init(){this._rootEl.innerHTML=Handlebars.templates["about.html"](),super.init()}deinit(){super.deinit()}}class g extends n{constructor(...e){super(...e)}render(e,t,r){"success"===r&&this._router.routeTo("/")}init(){this._subscriber.subscribeEvent("LoggedOut",this._render),this._controller.logout(),super.init()}deinit(){this._subscriber.unsubscribeEvent("LoggedOut",this._render),super.deinit()}}class _ extends n{constructor(e,t,r,s){super(e,t,r,s)}render(e,t,r){let s={};if("QuestionList"===t){const e=r.round,t=r.users;s={num:e.questionCount+1,themes:e.themes,users:t,isQuestionList:!0}}else"Question"===t?s={users:r.users,question:r.question,isQuestion:!0,num:1}:"Message"===t&&(s={users:r.users,message:r.message,isMessage:!0,num:1});this._rootEl.innerHTML=Handlebars.templates["svoyak.html"](s)}init(){this._controller.init(),this._addListener("click",e=>{const t=document.getElementById("questions");if(!t)return;let r=e.target;(t.isSameNode(r.parentElement)||(r=r.parentElement,t.isSameNode(r.parentElement)))&&(e.preventDefault(),this._controller.displayQuestion(r))}),this._addListener("submit",e=>{e.preventDefault(),this._form=e.target,o(this._form);const t=this._form.elements.answer.value;this._controller.displayAnswer(t)}),this._subscriber.subscribeEvent("QuestionList",this._render),this._subscriber.subscribeEvent("Question",this._render),this._subscriber.subscribeEvent("Message",this._render),super.init()}deinit(){super.deinit(),this._subscriber.unsubscribeEvent("QuestionList",this._render),this._subscriber.unsubscribeEvent("Question",this._render),this._subscriber.unsubscribeEvent("Message",this._render)}}class b extends n{constructor(e,t){super(e,t)}init(){this._rootEl.innerHTML=Handlebars.templates["404.html"](),super.init()}deinit(){super.deinit()}}class f extends n{constructor(...e){super(...e)}render(e,t,r){if("Msg"===t){let e=document.createElement("div");e.classList.add("message-orange");const t=document.createElement("span"),s=document.createElement("img");s.src=r.avatar,s.width=25,s.height=25,t.innerText=r.text,e.appendChild(s),e.appendChild(t),document.getElementById("text-field").appendChild(e),document.getElementById("msgform").reset()}else for(const e of r){let t=document.createElement("div");t.classList.add("message");const r=document.createElement("span"),s=document.createElement("img");s.width=25,s.height=25,s.src=e.avatar||"/public/img/avatar.jpg",null!=e.login?t.appendChild(s):e.login="Anon",r.innerText=e.login+":"+e.text,t.appendChild(r),document.getElementById("text-field").appendChild(t)}document.getElementById("text-field").scrollTop=8e3,console.log(this._controller.getLogin())}init(){this._subscriber.subscribeEvent("Msg",this._render),this._subscriber.subscribeEvent("Msgs",this._render),this._rootEl.innerHTML=Handlebars.templates["chat.html"](),document.getElementById("pop-up").addEventListener("submit",e=>{e.preventDefault(),this._form=e.target;const t=this._form.elements.text.value;this._controller.sendMsg(t)}),this._controller.loadHistory(),super.init()}deinit(){this._subscriber.unsubscribeEvent("Msg",this._render),this._subscriber.unsubscribeEvent("Msgs",this._render),super.deinit()}}class m{constructor(){this._state={},this._subscribers={}}getState(){return this._state}subscribeEvent(e,t){if("string"!=typeof e)throw new TypeError("key expected to be string");if("function"!=typeof t)throw new TypeError("callback expected to be a function");void 0===this._subscribers[e]&&(this._subscribers[e]=[]),this._subscribers[e].push(t)}unsubscribeEvent(e,t){if("string"!=typeof e)throw new TypeError("key expected to be string");if("function"!=typeof t)throw new TypeError("callback expected to be a function");if(void 0===this._subscribers[e])return;const r=this._subscribers[e].indexOf(t);-1!==r&&this._subscribers[e].splice(r,1)}dispatchEvent(e,t){if("string"!=typeof e)throw new TypeError("key expected to be string");if(this._state[e]=t,this._subscribers[e])for(const r of this._subscribers[e])r(this.getState(),e,t)}}const v=new m,E=new class{constructor(e){if(!(e instanceof m))throw new TypeError("instance of Dispatcher expected");this._dispatcher=e}subscribeEvent(e,t){this._dispatcher.subscribeEvent(e,t)}unsubscribeEvent(e,t){this._dispatcher.unsubscribeEvent(e,t)}}(v),y=new class{constructor(e){if(!(e instanceof m))throw new TypeError("instance of Dispatcher expected");this._dispatcher=e}dispatchEvent(e,t){this._dispatcher.dispatchEvent(e,t)}getState(){return this._dispatcher.getState()}}(v);var w=new class{doFetch({method:e="GET",path:t="/",body:r={}}={}){if("GET"===e||"HEAD"===e)return fetch(t,{method:e,mode:"cors",credentials:"include"});{let s={},o="";return r instanceof FormData?o=r:r&&(s={"Content-Type":"application/json; charset=utf-8"},o=JSON.stringify(r)),fetch(t,{method:e,body:o,headers:s,mode:"cors",credentials:"include"})}}};const L="https://api.kpacubo.xyz";var M=new class{constructor(){this._userMap=new Map}_sendRequest(e,t,r,s,o=[]){if("string"!=typeof e)throw new TypeError('"method" is not a string');if("string"!=typeof t)throw new TypeError('"url" is not a string');if("string"!=typeof s)throw new TypeError('"type" is not a string');if(!Array.isArray(o))throw new TypeError('"required" is not an Array');return w.doFetch({path:L+t,body:r,method:e}).then(e=>{if(!e.ok)throw e.statusText;return e.text().then(e=>e?JSON.parse(e):null)}).then(e=>{if(e&&"success"!==e.status)throw e;return e}).then(e=>{if(!e)return e;if(e.type!==s)throw"wrong response type";return e.payload}).then(e=>{if(0===o.length)return e;for(const t of o)if(!e.hasOwnProperty(t))throw console.log('Lack of property "'+t+'" in payload'),"payload is missing some required fields";return e})}register(e,t,r){const s={login:e,email:t,password:r};return this._sendRequest("POST","/api/register",s,"reg",["login","email","score"])}authorize(e,t){const r={login:e,password:t};return this._sendRequest("POST","/api/auth",r,"log",["login","email","score"])}updateUserInfo(e,t){const r={login:e,password:t};return this._sendRequest("PUT","/api/profile",r,"usinfo",["login","email","score"])}getUserInfo(){return this._sendRequest("GET","/api/profile",{},"usinfo",["login","email","score"])}getUsers(e){const t="/api/leaderboard/"+e;return this._sendRequest("GET",t,{},"uslist",["users"])}uploadAvatar(e){return this._sendRequest("POST","/api/upload_avatar",e,"usinfo",["login","email","avatar","score"])}logout(){return this._sendRequest("DELETE","/api/login",{},"logout")}getUserById(e){if(this._userMap.has(e))return this._userMap[e];const t="/api/user/"+e;return this._sendRequest("GET",t,{},"usinfo").then(t=>(this._userMap[e]=t,t))}getHistory(){return fetch("https://chat.kpacubo.xyz:2000/messages").this(e=>(console.log(e),e))}getChatHistory(){return fetch("https://chat.kpacubo.xyz:2000/messages",{method:"GET",mode:"cors"}).then(e=>{if(!e.ok)throw e.statusText;return e.json()}).then(e=>{if(!e||"success"!==e.status)throw e;return e.payload})}};const U=new class{_correctLength(e){return e.length>=4&&e.length<=25}_correctLengthOrEmpty(e){return this._correctLength(e)||0===e.length}_correctEmail(e){return Boolean(e.match(/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/))}_correctLogin(e){return Boolean(e.match(/^[a-zA-Z0-9_]+$/))}_correctLoginOrEmpty(e){return 0===e.length||this._correctLogin(e)}validateRegistration(e,t,r="",s=""){return this._correctLogin(e)?this._correctLength(e)?this._correctLength(t)?this._correctEmail(r)?t!==s?{error:"Passwords do not match",errorField:"repeat_password"}:{error:null,errorField:null}:{error:"Email is incorrect",errorField:"email"}:{error:"Password should be from 4 to 25 symbols long",errorField:"password"}:{error:"Login should be from 4 to 25 symbols long",errorField:"login"}:{error:"Login is incorrect",errorField:"login"}}validateLogin(e,t){return this._correctLogin(e)?this._correctLength(e)?this._correctLength(t)?{error:null,errorField:null}:{error:"Password should be from 4 to 25 symbols long",errorField:"password"}:{error:"Login should be from 4 to 25 symbols long",errorField:"login"}:{error:"Login is incorrect",errorField:"login"}}validateUpdate(e,t,r){return this._correctLoginOrEmpty(e)?this._correctLengthOrEmpty(e)?this._correctLengthOrEmpty(t)?t!==r?{error:"Passwords do not match",errorField:"repeat_password"}:{error:null,errorField:null}:{error:"Password should be from 4 to 25 symbols long",errorField:"password"}:{error:"Login should be empty or from 4 to 25 symbols long",errorField:"login"}:{error:"New login is incorrect",errorField:"login"}}};var T=class{constructor(e={}){this._generalInjections=e,this._constructors=new Map}addConstructor(e,t=[],{factoryArgs:r=[],injections:s={}}={}){e&&(this._constructors[e]=((...o)=>{const i=t.map(e=>{const t=r.indexOf(e);if(t>=0)return o[t];if(s.hasOwnProperty(e))return s[e];if(this._generalInjections.hasOwnProperty(e))return this._generalInjections[e];throw Error("no such attribute in received args or injections")});return new e(...i)}))}getFabricator(e){return this._constructors[e]}};class C{constructor(e,t,r){this._dispatcher=e,this._apiModule=t,this._UserModel=r}init(){fetch("/public/gameresources/singleplayer.json").then(e=>e.text()).then(e=>{this._pack=JSON.parse(e);for(const e of this._pack.rounds){e.questionCount=e.themes[0].questions.length,e.questionsLeft=e.questionCount*e.themes.length;for(const t of e.themes)for(const e of t.questions)e.active=!0;console.log(e.questionCount),console.log(e.questionsLeft)}const t=this._dispatcher.getState();if(this._user=[],t.User)this._user.push(t.User),this._user[0].score=0;else{const e={login:"Guest",img:"/public/img/avatar.jpg",score:0};this._user.push(e)}this._round=-1,this._changeRound()}).catch(e=>{console.log(e)})}_displayQuestions(){const e=this._user,t={round:this._pack.rounds[this._round],users:e};this._dispatcher.dispatchEvent("QuestionList",t)}displayQuestion(e){if(!(e instanceof Node))throw new TypeError("node expected");let t=-1;const r=e.parentElement;for(const s in r.childNodes)if(r.childNodes.hasOwnProperty(s)&&r.childNodes[s]===e){t=s;break}console.log(t);const s=Math.floor((t-1)/2);console.log(s);const o=s%(this._pack.rounds[this._round].questionCount+1)-1,i=Math.floor(s/(this._pack.rounds[this._round].questionCount+1));if(console.log(o),console.log(i),-1!==o){const e=this._pack.rounds[this._round].themes[i].questions[o];if(e.active){this._theme=i,this._question=o;const t=this._user;this._dispatcher.dispatchEvent("Question",{question:e.question,users:t})}}}displayAnswer(e){const t=this._user,r=this._pack.rounds[this._round].themes[this._theme].questions[this._question];let s=!1;for(const t of r.answers)if(e.toLowerCase()===t.toLowerCase()){s=!0;break}let o="";s?(o="You are right!",this._user[0].score+=r.value):(o="Correct answer is: "+r.answers[0],this._user[0].score-=r.value),r.active=!1,this._pack.rounds[this._round].questionsLeft--;let i=this._displayQuestions;0===this._pack.rounds[this._round].questionsLeft&&(i=this._changeRound);const n={message:o,users:t};setTimeout(()=>{i.bind(this)()},3e3),this._dispatcher.dispatchEvent("Message",n)}_changeRound(){if(this._round++,this._round===this._pack.rounds.length)return void this._endGame();const e={message:"Round "+(this._round+1),users:this._user};setTimeout(()=>{this._displayQuestions()},3e3),this._dispatcher.dispatchEvent("Message",e)}_endGame(){const e={message:"Game ended! Your score: "+this._user[0].score,users:this._user};this._dispatcher.dispatchEvent("Message",e)}}class F{constructor(e,t){this._dispatcher=e,this._apiModule=t}getLeaderboard(e){M.getUsers(e).then(t=>{this._dispatcher.dispatchEvent("LeaderboardLoaded",{users:t.users,pageCount:Math.ceil(t.count/10),currentPage:e-1})}).catch(e=>{console.log(e)})}}class x{constructor(e,t,r,s){this._dispatcher=e,this._apiModule=t,this._validator=r,this._UserModel=s}login(e,t){const r=this._validator.validateLogin(e,t);console.log(r),null===r.error?this._apiModule.authorize(e,t).then(e=>{const t=e.avatar||"";this._dispatcher.dispatchEvent("User",new this._UserModel(e.email,e.login,e.score,t)),this._dispatcher.dispatchEvent("LoggedIn","success")}).catch(e=>{"string"==typeof e?console.log(e):(e=e.payload,r.error=e.message,r.errorField=e.field,this._dispatcher.dispatchEvent("LoggedIn",r))}):this._dispatcher.dispatchEvent("LoggedIn",r)}}class k{constructor(e,t,r){this._dispatcher=e,this._apiModule=t,this._UserModel=r}getUser(){const e=this._dispatcher.getState();if(e.User){if(!e.User.img){const t=e.User,r=new this._UserModel(t.email,t.login,t.score,"public/img/avatar.jpg");this._dispatcher.dispatchEvent("User",r)}this._dispatcher.dispatchEvent("UserLoaded",e.User)}else null!==e.User?this._apiModule.getUserInfo().then(t=>{const r=t.avatar||"public/img/avatar.jpg";this._dispatcher.dispatchEvent("User",new this._UserModel(t.email,t.login,t.score,r)),this._dispatcher.dispatchEvent("UserLoaded",e.User)}).catch(e=>{console.log(e),this._dispatcher.dispatchEvent("User",null),this._dispatcher.dispatchEvent("UserLoaded",null)}):this._dispatcher.dispatchEvent("UserLoaded",null)}}class A{constructor(e,t,r,s){this._dispatcher=e,this._apiModule=t,this._validator=r,this._UserModel=s}signUp(e,t,r,s){const o=this._validator.validateRegistration(e,r,t,s);null===o.error?this._apiModule.register(e,t,r).then(e=>{this._dispatcher.dispatchEvent("User",new this._UserModel(e.email,e.login,e.score)),this._dispatcher.dispatchEvent("SignedUp","success")}).catch(e=>{"string"==typeof e?console.log(e):(e=e.payload,o.error=e.message,o.errorField=e.field,this._dispatcher.dispatchEvent("SignedUp",o))}):this._dispatcher.dispatchEvent("SignedUp",o)}}class H{constructor(e,t,r){this._dispatcher=e,this._apiModule=t,this._UserModel=r}logout(){this._apiModule.logout().then(()=>{this._dispatcher.dispatchEvent("User",null),this._dispatcher.dispatchEvent("LoggedOut","success")}).catch(e=>{console.log(e),this._dispatcher.dispatchEvent("LoggedOut",e)})}}class P{constructor(e,t,r,s){this._dispatcher=e,this._apiModule=t,this._validator=r,this._UserModel=s}updateProfile(e,t,r,s){const o=this._validator.validateUpdate(e,t,r);if(null===o.error){if(this._apiModule.updateUserInfo(e,t).then(e=>{const t=e.avatar||null;this._dispatcher.dispatchEvent("User",new this._UserModel(e.email,e.login,e.score,t)),this._dispatcher.dispatchEvent("ProfileUpdated","success")}).catch(e=>{if("string"==typeof e)console.log(e);else{const t={error:(e=e.payload).message,errorField:e.field};this._dispatcher.dispatchEvent("ProfileUpdated",t)}}),s.value){const e=new FormData;e.append("avatar",s.files[0]),this._apiModule.uploadAvatar(e).then(e=>{const t=e.avatar||null;this._dispatcher.dispatchEvent("User",new this._UserModel(e.email,e.login,e.score,t)),this._dispatcher.dispatchEvent("AvatarUpdated","success")}).catch(e=>{if("string"==typeof e)console.log(e);else{const t={error:(e=e.payload).message,errorField:e.field};this._dispatcher.dispatchEvent("AvatarUpdated",t)}})}}else this._dispatcher.dispatchEvent("ProfileUpdated",o)}}class R{constructor(e,t){this._dispatcher=e,this._apiModule=t,this._socket=new WebSocket("wss://chat.kpacubo.xyz:2000/ws"),this._socket.onopen=(()=>{console.log("Соединение установлено.")}),this._socket.onclose=(e=>{e.wasClean?console.log("Соединение закрыто чисто"):console.log("Обрыв соединения"),console.log("Код: "+e.code+" причина: "+e.reason)}),this._socket.onmessage=(e=>{const t=JSON.parse(e.data);""!==t.uid?this._apiModule.getUserById(t.uid).then(e=>{this._dispatcher.dispatchEvent("Msg",{text:e.login+":"+t.text,avatar:e.avatar||"public/img/avatar.jpg"})}):this._dispatcher.dispatchEvent("Msg",{text:"anon:"+t.text,avatar:"public/img/avatar.jpg"})}),this._socket.onerror=(e=>{console.log("Ошибка "+e.message)})}sendMsg(e){this._socket.send(JSON.stringify({text:e}))}loadHistory(){this._apiModule.getChatHistory().then(e=>{e=e.reverse(),this._dispatcher.dispatchEvent("Msgs",e),console.log(e)}).catch(e=>{console.log(e)})}getLogin(){return this._apiModule.getUserInfo()}}const O=new T({apiModule:M,validator:U,UserModel:class{constructor(e,t,r,s=""){this._email=e,this._login=t,this._img=s,this._score=r}get email(){return this._email}get login(){return this._login}get img(){return this._img}get score(){return this._score}set score(e){this._score=e}},dispatcher:y});O.addConstructor(F,["dispatcher","apiModule"]),O.addConstructor(x,["dispatcher","apiModule","validator","UserModel"]),O.addConstructor(k,["dispatcher","apiModule","UserModel"]),O.addConstructor(A,["dispatcher","apiModule","validator","UserModel"]),O.addConstructor(H,["dispatcher","apiModule","UserModel"]),O.addConstructor(P,["dispatcher","apiModule","validator","UserModel"]),O.addConstructor(C,["dispatcher","apiModule","UserModel"]),O.addConstructor(R,["dispatcher","apiModule"]);const q=O.getFabricator(F)(),j=O.getFabricator(x)(),S=O.getFabricator(k)(),I=O.getFabricator(A)(),N=O.getFabricator(H)(),B=O.getFabricator(P)(),D=O.getFabricator(C)(),Q=O.getFabricator(R)();function z(e,t,r){r.addRoute("/",e.getFabricator(a)),r.addRoute("/login",e.getFabricator(c)),r.addRoute("/profile",e.getFabricator(d)),r.addRoute("/settings",e.getFabricator(l)),r.addRoute("/signup",e.getFabricator(u)),r.addRoute("/leaderboard",e.getFabricator(h)),r.addRoute("/about",e.getFabricator(p)),r.addRoute("/logout",e.getFabricator(g)),r.addRoute("/singleplayer",e.getFabricator(_)),r.addRoute("/chat",e.getFabricator(f)),r.notFoundRouteMaker=e.newNotFoundRoute;const s=function(){const e=window.location.href,t=e.indexOf("//");let r=e.slice(t+2);const s=r.indexOf("/");return r=r.slice(s)}();r.setDefaultRoute(s),r.init(),function(e,t){e instanceof Node&&t instanceof i&&(e.addEventListener("click",e=>{if(!(e.target instanceof HTMLAnchorElement))return;e.preventDefault();const r=e.target.getAttribute("href");t.routeTo(r),console.log(`<a> go to ${r}`)}),window.addEventListener("popstate",function(){console.log(location.pathname),t.routeTo(location.pathname,!1)},!1))}(t,r)}"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("sw.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})}),window.onload=(()=>{const e=document.getElementById("root"),t=new i(e);z(function(){const e=new T({subscriber:E});return e.addConstructor(a,["rootEl","router","controller","subscriber","loginController","signupController"],{factoryArgs:["rootEl","router"],injections:{controller:S,loginController:j,signupController:I}}),e.addConstructor(c,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:j}}),e.addConstructor(d,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:S}}),e.addConstructor(l,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:B}}),e.addConstructor(u,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:I}}),e.addConstructor(h,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:q}}),e.addConstructor(p,["rootEl","router"],{factoryArgs:["rootEl","router"]}),e.addConstructor(f,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:Q}}),e.addConstructor(g,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:N}}),e.addConstructor(_,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:D}}),e.addConstructor(b,["rootEl","router"],{factoryArgs:["rootEl","router"]}),e}(),e,t),window.addEventListener("fetch",e=>{console.log(e)})})}]);