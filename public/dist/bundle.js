!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";function n(e,t,r){var n=e.elements[t],o=document.createElement("p");o.setAttribute("style","margin: 0;"),o.innerText=r,n.nextElementSibling.appendChild(o)}function o(e){var t=e.getElementsByClassName("error-msg");Array.prototype.forEach.call(t,function(e){e.innerHTML=""})}function i(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}r.r(t);var s=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!(t instanceof Node))throw new TypeError("rootEl must be Node");this._rootEl=t,this._routeMakerFns={},this._defaultRoutePath=null,this._currentRoute=null,this.notFoundRouteMaker=null}var t,r,n;return t=e,(r=[{key:"addRoute",value:function(e,t){"string"==typeof e&&"function"==typeof t&&(this._routeMakerFns[e]=t)}},{key:"setDefaultRoute",value:function(e){"string"==typeof e&&(this._defaultRoutePath=e)}},{key:"init",value:function(){this.routeTo(this._defaultRoutePath,!1)}},{key:"routeTo",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if("string"==typeof e){t?(console.log("Pushing",e),history.pushState(null,null,e)):console.log("Poping",e),this._currentRoute&&(this._currentRoute.deinit&&this._currentRoute.deinit(),this._currentRoute=null);var r=this._routeMakerFns[e];r||(console.log("OI MATE"),r=this.notFoundRouteMaker);var n=r(this._rootEl,this);n&&(this._currentRoute=n,n.init&&n.init())}}}])&&i(t.prototype,r),n&&i(t,n),e}();function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e,t){return!t||"object"!==a(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function l(e,t,r){return(l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=c(e)););return e}(e,t);if(n){var o=Object.getOwnPropertyDescriptor(n,t);return o.get?o.get.call(r):o.value}})(e,t,r||e)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function v(e,t,r){return t&&p(e.prototype,t),r&&p(e,r),e}Handlebars.registerHelper("pagination",function(e,t,r,n){var o,i;3===arguments.length&&(n=r,r=5),o=e-Math.floor(r/2),i=e+Math.floor(r/2),o<=0&&(i-=o-1,o=1),i>t&&(o=(i=t)-r+1>0?i-r+1:1);var s={startFromFirstPage:!1,pages:[],endAtLastPage:!1};1===o&&(s.startFromFirstPage=!0);for(var a=o;a<=i;a++)s.pages.push({page:a,isCurrent:a===e});return i===t&&(s.endAtLastPage=!0),n.fn(s)});var g=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(f(this,e),!(t instanceof Node))throw new TypeError("rootEl must be Node");if(!(r instanceof s))throw new TypeError("router must be Router");this._rootEl=t,this._router=r,this._controller=n,this._subscriber=o,this._eventHandlers={},this.render&&(this._render=this.render.bind(this))}return v(e,[{key:"_addListener",value:function(e,t){e in this._eventHandlers||(this._eventHandlers[e]=[]),this._eventHandlers[e].push(t),this._rootEl.addEventListener(e,t)}},{key:"_removeAllListeners",value:function(e){if(e in this._eventHandlers)for(var t=this._eventHandlers[e],r=t.length;r--;){var n=t[r];this._rootEl.removeEventListener(e,n)}}},{key:"init",value:function(){}},{key:"deinit",value:function(){for(event in this._rootEl.innerHTML="",this._eventHandlers)this._eventHandlers.hasOwnProperty(event)&&this._removeAllListeners(event)}}]),e}(),y=function(e){function t(){var e,r;f(this,t);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return(r=u(this,(e=c(t)).call.apply(e,[this].concat(o))))._loginController=o[4],r._signupController=o[5],r}return d(t,g),v(t,[{key:"render",value:function(e,t,r){e.User?this._rootEl.innerHTML=Handlebars.templates["menu.html"]({isAuthorized:!0}):r||(this._rootEl.innerHTML=Handlebars.templates["menu.html"]({isAuthorized:null}))}},{key:"init",value:function(){var e=this;this._addListener("submit",function(t){t.preventDefault(),e._form=t.target,o(e._form);var r=e._form.elements.login.value,n=e._form.elements.password.value;e._loginController.login(r,n)}),this._subscriber.subscribeEvent("LoggedIn",this._render),this._addListener("click",function(e){e.preventDefault();var t=document.getElementById("myBtn"),r=document.getElementById("myModal");if(e.target!=r){if(e.target==t)return r.style.display="block",void document.getElementById("defaultOpen").click();if("submit"==e.target.name){var n=new CustomEvent("submit");return n.initCustomEvent("submit",!0,!0),void document.forms.loginform.dispatchEvent(n)}var o,i,s;if(i=document.getElementsByClassName("tabcontent"),s=document.getElementsByClassName("tablinks"),Array.prototype.slice.call(s).includes(e.target)){for(o=0;o<i.length;o++)i[o].style.display="none";for(s=document.getElementsByClassName("tablinks"),o=0;o<s.length;o++)s[o].className=s[o].className.replace(" active","");document.getElementById(e.target.innerText).style.display="block",e.currentTarget.className+=" active"}}else r.style.display="none"}),this._subscriber.subscribeEvent("UserLoaded",this._render),this._controller.getUser(),l(c(t.prototype),"init",this).call(this)}},{key:"deinit",value:function(){this._subscriber.unsubscribeEvent("UserLoaded",this._render),this._rootEl.innerHTML="",l(c(t.prototype),"deinit",this).call(this)}}]),t}(),_=function(e){function t(){var e;f(this,t);for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return u(this,(e=c(t)).call.apply(e,[this].concat(n)))}return d(t,g),v(t,[{key:"render",value:function(e,t,r){"success"!==r?n(this._form,r.errorField,r.error):this._router.routeTo("/")}},{key:"init",value:function(){var e=this;this._rootEl.innerHTML=Handlebars.templates["login.html"](),this._addListener("submit",function(t){t.preventDefault(),e._form=t.target,o(e._form);var r=e._form.elements.login.value,n=e._form.elements.password.value;e._controller.login(r,n)}),this._subscriber.subscribeEvent("LoggedIn",this._render),l(c(t.prototype),"init",this).call(this)}},{key:"deinit",value:function(){this._subscriber.unsubscribeEvent("LoggedIn",this._render),l(c(t.prototype),"deinit",this).call(this)}}]),t}(),b=function(e){function t(){var e;f(this,t);for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return u(this,(e=c(t)).call.apply(e,[this].concat(n)))}return d(t,g),v(t,[{key:"render",value:function(e,t,r){"success"===r?("ProfileUpdated"===t&&(this._waitingAvatarUpdate=!1),"AvatarUpdated"===t&&(this._waitingAvatarUpdate=!1),this._waitingProfileUpdate&&this._waitingAvatarUpdate||this._router.routeTo("/")):n(this._form,r.errorField,r.error)}},{key:"init",value:function(){var e=this;this._rootEl.innerHTML=Handlebars.templates["settings.html"](),this._addListener("submit",function(t){t.preventDefault(),e._form=t.target,o(e._form);var r=e._form.elements.login.value,n=e._form.elements.password.value,i=e._form.elements.repeat_password.value,s=e._form.elements.avatar;s.value&&(e._waitingAvatarUpdate=!0),e._controller.updateProfile(r,n,i,s)}),this._waitingProfileUpdate=!0,this._subscriber.subscribeEvent("ProfileUpdated",this._render),this._subscriber.subscribeEvent("AvatarUpdated",this._render),l(c(t.prototype),"init",this).call(this)}},{key:"deinit",value:function(){this._subscriber.unsubscribeEvent("ProfileUpdated",this._render),this._subscriber.unsubscribeEvent("AvatarUpdated",this._render),l(c(t.prototype),"deinit",this).call(this)}}]),t}(),m=function(e){function t(){var e;f(this,t);for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return u(this,(e=c(t)).call.apply(e,[this].concat(n)))}return d(t,g),v(t,[{key:"render",value:function(e,t,r){if(r){var n=r;this._rootEl.innerHTML=Handlebars.templates["profile.html"]({login:n.login,email:n.email,avatar_path:n.img,score:n.score})}else this._router.routeTo("/")}},{key:"init",value:function(){this._subscriber.subscribeEvent("UserLoaded",this._render),this._controller.getUser(),l(c(t.prototype),"init",this).call(this)}},{key:"deinit",value:function(){this._subscriber.unsubscribeEvent("UserLoaded",this._render),l(c(t.prototype),"deinit",this).call(this)}}]),t}(),E=function(e){function t(){var e;f(this,t);for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return u(this,(e=c(t)).call.apply(e,[this].concat(n)))}return d(t,g),v(t,[{key:"render",value:function(e,t,r){"success"!==r?n(this._form,r.errorField,r.error):this._router.routeTo("/")}},{key:"init",value:function(){var e=this;this._rootEl.innerHTML=Handlebars.templates["signup.html"](),this._addListener("submit",function(t){t.preventDefault(),e._form=t.target,o(e._form);var r=e._form.elements.login.value,n=e._form.elements.email.value,i=e._form.elements.password.value,s=e._form.elements.repeat_password.value;e._controller.signUp(r,n,i,s)}),this._subscriber.subscribeEvent("SignedUp",this._render),l(c(t.prototype),"init",this).call(this)}},{key:"deinit",value:function(){this._subscriber.unsubscribeEvent("SignedUp",this._render),l(c(t.prototype),"deinit",this).call(this)}}]),t}(),w=function(e){function t(){var e;f(this,t);for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return u(this,(e=c(t)).call.apply(e,[this].concat(n)))}return d(t,g),v(t,[{key:"prerender",value:function(){this.render({},"",{users:[],pageCount:0,currentPage:0})}},{key:"render",value:function(e,t,r){var n=this;this._rootEl.innerHTML=Handlebars.templates["leaderboard.html"]({users:r.users,pageCount:r.pageCount,currentPage:r.currentPage,size:"5"}),document.getElementById("pagination").addEventListener("click",function(e){e.preventDefault();var t=e.target.getAttribute("href");n._controller.getLeaderboard(t)})}},{key:"init",value:function(){this.prerender(),this._subscriber.subscribeEvent("LeaderboardLoaded",this._render),this._controller.getLeaderboard(1),l(c(t.prototype),"init",this).call(this)}},{key:"deinit",value:function(){this._subscriber.unsubscribeEvent("LeaderboardLoaded",this._render),l(c(t.prototype),"deinit",this).call(this)}}]),t}(),k=function(e){function t(e,r){return f(this,t),u(this,c(t).call(this,e,r))}return d(t,g),v(t,[{key:"init",value:function(){this._rootEl.innerHTML=Handlebars.templates["about.html"](),l(c(t.prototype),"init",this).call(this)}},{key:"deinit",value:function(){l(c(t.prototype),"deinit",this).call(this)}}]),t}(),L=function(e){function t(){var e;f(this,t);for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return u(this,(e=c(t)).call.apply(e,[this].concat(n)))}return d(t,g),v(t,[{key:"render",value:function(e,t,r){"success"===r&&this._router.routeTo("/")}},{key:"init",value:function(){this._subscriber.subscribeEvent("LoggedOut",this._render),this._controller.logout(),l(c(t.prototype),"init",this).call(this)}},{key:"deinit",value:function(){this._subscriber.unsubscribeEvent("LoggedOut",this._render),l(c(t.prototype),"deinit",this).call(this)}}]),t}(),M=function(e){function t(e,r,n,o){return f(this,t),u(this,c(t).call(this,e,r,n,o))}return d(t,g),v(t,[{key:"render",value:function(e,t,r){var n={};if("QuestionList"===t){var o=r.round,i=r.users;n={num:o.questionCount+1,themes:o.themes,users:i,isQuestionList:!0}}else"Question"===t?n={users:r.users,question:r.question,isQuestion:!0,num:1}:"Message"===t&&(n={users:r.users,message:r.message,isMessage:!0,num:1});this._rootEl.innerHTML=Handlebars.templates["svoyak.html"](n)}},{key:"init",value:function(){var e=this;this._controller.init(),this._addListener("click",function(t){var r=document.getElementById("questions");if(r){var n=t.target;(r.isSameNode(n.parentElement)||(n=n.parentElement,r.isSameNode(n.parentElement)))&&(t.preventDefault(),e._controller.displayQuestion(n))}}),this._addListener("submit",function(t){t.preventDefault(),e._form=t.target,o(e._form);var r=e._form.elements.answer.value;e._controller.displayAnswer(r)}),this._subscriber.subscribeEvent("QuestionList",this._render),this._subscriber.subscribeEvent("Question",this._render),this._subscriber.subscribeEvent("Message",this._render),l(c(t.prototype),"init",this).call(this)}},{key:"deinit",value:function(){l(c(t.prototype),"deinit",this).call(this),this._subscriber.unsubscribeEvent("QuestionList",this._render),this._subscriber.unsubscribeEvent("Question",this._render),this._subscriber.unsubscribeEvent("Message",this._render)}}]),t}(),U=function(e){function t(e,r){return f(this,t),u(this,c(t).call(this,e,r))}return d(t,g),v(t,[{key:"init",value:function(){this._rootEl.innerHTML=Handlebars.templates["404.html"](),l(c(t.prototype),"init",this).call(this)}},{key:"deinit",value:function(){l(c(t.prototype),"deinit",this).call(this)}}]),t}(),T=function(e){function t(){var e;f(this,t);for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return u(this,(e=c(t)).call.apply(e,[this].concat(n)))}return d(t,g),v(t,[{key:"render",value:function(e,t,r){if("Msg"===t){var n=document.createElement("div");n.classList.add("message-orange");var o=document.createElement("span"),i=document.createElement("img");i.src=r.avatar,i.width=25,i.height=25,o.innerText=r.text,n.appendChild(i),n.appendChild(o),document.getElementById("text-field").appendChild(n),document.getElementById("msgform").reset()}else{var s=!0,a=!1,u=void 0;try{for(var l,c=r[Symbol.iterator]();!(s=(l=c.next()).done);s=!0){var d=l.value,h=document.createElement("div");h.classList.add("message");var f=document.createElement("span"),p=document.createElement("img");p.width=25,p.height=25,p.src=d.avatar||"/public/img/avatar.jpg",null!=d.login?h.appendChild(p):d.login="Anon",f.innerText=d.login+":"+d.text,h.appendChild(f),document.getElementById("text-field").appendChild(h)}}catch(e){a=!0,u=e}finally{try{s||null==c.return||c.return()}finally{if(a)throw u}}}document.getElementById("text-field").scrollTop=8e3,console.log(this._controller.getLogin())}},{key:"init",value:function(){var e=this;this._subscriber.subscribeEvent("Msg",this._render),this._subscriber.subscribeEvent("Msgs",this._render),this._rootEl.innerHTML=Handlebars.templates["chat.html"](),document.getElementById("pop-up").addEventListener("submit",function(t){t.preventDefault(),e._form=t.target;var r=e._form.elements.text.value;e._controller.sendMsg(r)}),this._controller.loadHistory(),l(c(t.prototype),"init",this).call(this)}},{key:"deinit",value:function(){this._subscriber.unsubscribeEvent("Msg",this._render),this._subscriber.unsubscribeEvent("Msgs",this._render),l(c(t.prototype),"deinit",this).call(this)}}]),t}();function C(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function O(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function A(e,t,r){return t&&O(e.prototype,t),r&&O(e,r),e}var P=function(){function e(){C(this,e),this._state={},this._subscribers={}}return A(e,[{key:"getState",value:function(){return this._state}},{key:"subscribeEvent",value:function(e,t){if("string"!=typeof e)throw new TypeError("key expected to be string");if("function"!=typeof t)throw new TypeError("callback expected to be a function");void 0===this._subscribers[e]&&(this._subscribers[e]=[]),this._subscribers[e].push(t)}},{key:"unsubscribeEvent",value:function(e,t){if("string"!=typeof e)throw new TypeError("key expected to be string");if("function"!=typeof t)throw new TypeError("callback expected to be a function");if(void 0!==this._subscribers[e]){var r=this._subscribers[e].indexOf(t);-1!==r&&this._subscribers[e].splice(r,1)}}},{key:"dispatchEvent",value:function(e,t){if("string"!=typeof e)throw new TypeError("key expected to be string");if(this._state[e]=t,this._subscribers[e]){var r=!0,n=!1,o=void 0;try{for(var i,s=this._subscribers[e][Symbol.iterator]();!(r=(i=s.next()).done);r=!0){(0,i.value)(this.getState(),e,t)}}catch(e){n=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw o}}}}}]),e}(),F=function(){function e(t){if(C(this,e),!(t instanceof P))throw new TypeError("instance of Dispatcher expected");this._dispatcher=t}return A(e,[{key:"dispatchEvent",value:function(e,t){this._dispatcher.dispatchEvent(e,t)}},{key:"getState",value:function(){return this._dispatcher.getState()}}]),e}(),j=function(){function e(t){if(C(this,e),!(t instanceof P))throw new TypeError("instance of Dispatcher expected");this._dispatcher=t}return A(e,[{key:"subscribeEvent",value:function(e,t){this._dispatcher.subscribeEvent(e,t)}},{key:"unsubscribeEvent",value:function(e,t){this._dispatcher.unsubscribeEvent(e,t)}}]),e}(),R=new P,x=new j(R),S=new F(R);function H(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var q=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n;return t=e,(r=[{key:"doFetch",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.method,r=void 0===t?"GET":t,n=e.path,o=void 0===n?"/":n,i=e.body,s=void 0===i?{}:i;if("GET"===r||"HEAD"===r)return fetch(o,{method:r,mode:"cors",credentials:"include"});var a={},u="";return s instanceof FormData?u=s:s&&(a={"Content-Type":"application/json; charset=utf-8"},u=JSON.stringify(s)),fetch(o,{method:r,body:u,headers:a,mode:"cors",credentials:"include"})}}])&&H(t.prototype,r),n&&H(t,n),e}());function I(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var N=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._userMap=new Map}var t,r,n;return t=e,(r=[{key:"_sendRequest",value:function(e,t,r,n){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];if("string"!=typeof e)throw new TypeError('"method" is not a string');if("string"!=typeof t)throw new TypeError('"url" is not a string');if("string"!=typeof n)throw new TypeError('"type" is not a string');if(!Array.isArray(o))throw new TypeError('"required" is not an Array');return q.doFetch({path:"https://api.kpacubo.xyz"+t,body:r,method:e}).then(function(e){if(!e.ok)throw e.statusText;return e.text().then(function(e){return e?JSON.parse(e):null})}).then(function(e){if(e&&"success"!==e.status)throw e;return e}).then(function(e){if(!e)return e;if(e.type!==n)throw"wrong response type";return e.payload}).then(function(e){if(0===o.length)return e;var t=!0,r=!1,n=void 0;try{for(var i,s=o[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var a=i.value;if(!e.hasOwnProperty(a))throw console.log('Lack of property "'+a+'" in payload'),"payload is missing some required fields"}}catch(e){r=!0,n=e}finally{try{t||null==s.return||s.return()}finally{if(r)throw n}}return e})}},{key:"register",value:function(e,t,r){var n={login:e,email:t,password:r};return this._sendRequest("POST","/api/register",n,"reg",["login","email","score"])}},{key:"authorize",value:function(e,t){var r={login:e,password:t};return this._sendRequest("POST","/api/auth",r,"log",["login","email","score"])}},{key:"updateUserInfo",value:function(e,t){var r={login:e,password:t};return this._sendRequest("PUT","/api/profile",r,"usinfo",["login","email","score"])}},{key:"getUserInfo",value:function(){return this._sendRequest("GET","/api/profile",{},"usinfo",["login","email","score"])}},{key:"getUsers",value:function(e){var t="/api/leaderboard/"+e;return this._sendRequest("GET",t,{},"uslist",["users"])}},{key:"uploadAvatar",value:function(e){return this._sendRequest("POST","/api/upload_avatar",e,"usinfo",["login","email","avatar","score"])}},{key:"logout",value:function(){return this._sendRequest("DELETE","/api/login",{},"logout")}},{key:"getUserById",value:function(e){var t=this;if(this._userMap.has(e))return this._userMap[e];var r="/api/user/"+e;return this._sendRequest("GET",r,{},"usinfo").then(function(r){return t._userMap[e]=r,r})}},{key:"getHistory",value:function(){return fetch("https://chat.kpacubo.xyz:2000/messages").this(function(e){return console.log(e),e})}},{key:"getChatHistory",value:function(){return fetch("https://chat.kpacubo.xyz:2000/messages",{method:"GET",mode:"cors"}).then(function(e){if(!e.ok)throw e.statusText;return e.json()}).then(function(e){if(!e||"success"!==e.status)throw e;return e.payload})}}])&&I(t.prototype,r),n&&I(t,n),e}());function B(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var D=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n;return t=e,(r=[{key:"_correctLength",value:function(e){return e.length>=4&&e.length<=25}},{key:"_correctLengthOrEmpty",value:function(e){return this._correctLength(e)||0===e.length}},{key:"_correctEmail",value:function(e){return Boolean(e.match(/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/))}},{key:"_correctLogin",value:function(e){return Boolean(e.match(/^[a-zA-Z0-9_]+$/))}},{key:"_correctLoginOrEmpty",value:function(e){return 0===e.length||this._correctLogin(e)}},{key:"validateRegistration",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return this._correctLogin(e)?this._correctLength(e)?this._correctLength(t)?this._correctEmail(r)?t!==n?{error:"Passwords do not match",errorField:"repeat_password"}:{error:null,errorField:null}:{error:"Email is incorrect",errorField:"email"}:{error:"Password should be from 4 to 25 symbols long",errorField:"password"}:{error:"Login should be from 4 to 25 symbols long",errorField:"login"}:{error:"Login is incorrect",errorField:"login"}}},{key:"validateLogin",value:function(e,t){return this._correctLogin(e)?this._correctLength(e)?this._correctLength(t)?{error:null,errorField:null}:{error:"Password should be from 4 to 25 symbols long",errorField:"password"}:{error:"Login should be from 4 to 25 symbols long",errorField:"login"}:{error:"Login is incorrect",errorField:"login"}}},{key:"validateUpdate",value:function(e,t,r){return this._correctLoginOrEmpty(e)?this._correctLengthOrEmpty(e)?this._correctLengthOrEmpty(t)?t!==r?{error:"Passwords do not match",errorField:"repeat_password"}:{error:null,errorField:null}:{error:"Password should be from 4 to 25 symbols long",errorField:"password"}:{error:"Login should be empty or from 4 to 25 symbols long",errorField:"login"}:{error:"New login is incorrect",errorField:"login"}}}])&&B(t.prototype,r),n&&B(t,n),e}());function Q(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var z=function(){function e(t,r,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._email=t,this._login=r,this._img=o,this._score=n}var t,r,n;return t=e,(r=[{key:"email",get:function(){return this._email}},{key:"login",get:function(){return this._login}},{key:"img",get:function(){return this._img}},{key:"score",get:function(){return this._score},set:function(e){this._score=e}}])&&Q(t.prototype,r),n&&Q(t,n),e}();function G(e,t,r){return(G=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&J(o,r.prototype),o}).apply(null,arguments)}function J(e,t){return(J=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function W(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function Z(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Y=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._generalInjections=t,this._constructors=new Map}var t,r,n;return t=e,(r=[{key:"addConstructor",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=n.factoryArgs,i=void 0===o?[]:o,s=n.injections,a=void 0===s?{}:s;e&&(this._constructors[e]=function(){for(var n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];var u=r.map(function(e){var r=i.indexOf(e);if(r>=0)return o[r];if(a.hasOwnProperty(e))return a[e];if(t._generalInjections.hasOwnProperty(e))return t._generalInjections[e];throw Error("no such attribute in received args or injections")});return G(e,W(u))})}},{key:"getFabricator",value:function(e){return this._constructors[e]}}])&&Z(t.prototype,r),n&&Z(t,n),e}();function $(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var K=function(){function e(t,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._dispatcher=t,this._apiModule=r,this._UserModel=n}var t,r,n;return t=e,(r=[{key:"init",value:function(){var e=this;fetch("/public/gameresources/singleplayer.json").then(function(e){return e.text()}).then(function(t){e._pack=JSON.parse(t);var r=!0,n=!1,o=void 0;try{for(var i,s=e._pack.rounds[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var a=i.value;a.questionCount=a.themes[0].questions.length,a.questionsLeft=a.questionCount*a.themes.length;var u=!0,l=!1,c=void 0;try{for(var d,h=a.themes[Symbol.iterator]();!(u=(d=h.next()).done);u=!0){var f=d.value,p=!0,v=!1,g=void 0;try{for(var y,_=f.questions[Symbol.iterator]();!(p=(y=_.next()).done);p=!0){y.value.active=!0}}catch(e){v=!0,g=e}finally{try{p||null==_.return||_.return()}finally{if(v)throw g}}}}catch(e){l=!0,c=e}finally{try{u||null==h.return||h.return()}finally{if(l)throw c}}console.log(a.questionCount),console.log(a.questionsLeft)}}catch(e){n=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw o}}var b=e._dispatcher.getState();if(e._user=[],b.User)e._user.push(b.User),e._user[0].score=0;else{e._user.push({login:"Guest",img:"/public/img/avatar.jpg",score:0})}e._round=-1,e._changeRound()}).catch(function(e){console.log(e)})}},{key:"_displayQuestions",value:function(){var e=this._user,t={round:this._pack.rounds[this._round],users:e};this._dispatcher.dispatchEvent("QuestionList",t)}},{key:"displayQuestion",value:function(e){if(!(e instanceof Node))throw new TypeError("node expected");var t=-1,r=e.parentElement;for(var n in r.childNodes)if(r.childNodes.hasOwnProperty(n)&&r.childNodes[n]===e){t=n;break}console.log(t);var o=Math.floor((t-1)/2);console.log(o);var i=o%(this._pack.rounds[this._round].questionCount+1)-1,s=Math.floor(o/(this._pack.rounds[this._round].questionCount+1));if(console.log(i),console.log(s),-1!==i){var a=this._pack.rounds[this._round].themes[s].questions[i];if(a.active){this._theme=s,this._question=i;var u=this._user;this._dispatcher.dispatchEvent("Question",{question:a.question,users:u})}}}},{key:"displayAnswer",value:function(e){var t=this,r=this._user,n=this._pack.rounds[this._round].themes[this._theme].questions[this._question],o=!1,i=!0,s=!1,a=void 0;try{for(var u,l=n.answers[Symbol.iterator]();!(i=(u=l.next()).done);i=!0){var c=u.value;if(e.toLowerCase()===c.toLowerCase()){o=!0;break}}}catch(e){s=!0,a=e}finally{try{i||null==l.return||l.return()}finally{if(s)throw a}}var d="";o?(d="You are right!",this._user[0].score+=n.value):(d="Correct answer is: "+n.answers[0],this._user[0].score-=n.value),n.active=!1,this._pack.rounds[this._round].questionsLeft--;var h=this._displayQuestions;0===this._pack.rounds[this._round].questionsLeft&&(h=this._changeRound);var f={message:d,users:r};setTimeout(function(){h.bind(t)()},3e3),this._dispatcher.dispatchEvent("Message",f)}},{key:"_changeRound",value:function(){var e=this;if(this._round++,this._round!==this._pack.rounds.length){var t={message:"Round "+(this._round+1),users:this._user};setTimeout(function(){e._displayQuestions()},3e3),this._dispatcher.dispatchEvent("Message",t)}else this._endGame()}},{key:"_endGame",value:function(){var e={message:"Game ended! Your score: "+this._user[0].score,users:this._user};this._dispatcher.dispatchEvent("Message",e)}}])&&$(t.prototype,r),n&&$(t,n),e}();function V(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function X(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ee(e,t,r){return t&&X(e.prototype,t),r&&X(e,r),e}var te=function(){function e(t,r){V(this,e),this._dispatcher=t,this._apiModule=r}return ee(e,[{key:"getLeaderboard",value:function(e){var t=this;N.getUsers(e).then(function(r){t._dispatcher.dispatchEvent("LeaderboardLoaded",{users:r.users,pageCount:Math.ceil(r.count/10),currentPage:e-1})}).catch(function(e){console.log(e)})}}]),e}(),re=function(){function e(t,r,n,o){V(this,e),this._dispatcher=t,this._apiModule=r,this._validator=n,this._UserModel=o}return ee(e,[{key:"login",value:function(e,t){var r=this,n=this._validator.validateLogin(e,t);console.log(n),null===n.error?this._apiModule.authorize(e,t).then(function(e){var t=e.avatar||"";r._dispatcher.dispatchEvent("User",new r._UserModel(e.email,e.login,e.score,t)),r._dispatcher.dispatchEvent("LoggedIn","success")}).catch(function(e){"string"==typeof e?console.log(e):(e=e.payload,n.error=e.message,n.errorField=e.field,r._dispatcher.dispatchEvent("LoggedIn",n))}):this._dispatcher.dispatchEvent("LoggedIn",n)}}]),e}(),ne=function(){function e(t,r,n){V(this,e),this._dispatcher=t,this._apiModule=r,this._UserModel=n}return ee(e,[{key:"getUser",value:function(){var e=this,t=this._dispatcher.getState();if(t.User){if(!t.User.img){var r=t.User,n=new this._UserModel(r.email,r.login,r.score,"public/img/avatar.jpg");this._dispatcher.dispatchEvent("User",n)}this._dispatcher.dispatchEvent("UserLoaded",t.User)}else null!==t.User?this._apiModule.getUserInfo().then(function(r){var n=r.avatar||"public/img/avatar.jpg";e._dispatcher.dispatchEvent("User",new e._UserModel(r.email,r.login,r.score,n)),e._dispatcher.dispatchEvent("UserLoaded",t.User)}).catch(function(t){console.log(t),e._dispatcher.dispatchEvent("User",null),e._dispatcher.dispatchEvent("UserLoaded",null)}):this._dispatcher.dispatchEvent("UserLoaded",null)}}]),e}(),oe=function(){function e(t,r,n,o){V(this,e),this._dispatcher=t,this._apiModule=r,this._validator=n,this._UserModel=o}return ee(e,[{key:"signUp",value:function(e,t,r,n){var o=this,i=this._validator.validateRegistration(e,r,t,n);null===i.error?this._apiModule.register(e,t,r).then(function(e){o._dispatcher.dispatchEvent("User",new o._UserModel(e.email,e.login,e.score)),o._dispatcher.dispatchEvent("SignedUp","success")}).catch(function(e){"string"==typeof e?console.log(e):(e=e.payload,i.error=e.message,i.errorField=e.field,o._dispatcher.dispatchEvent("SignedUp",i))}):this._dispatcher.dispatchEvent("SignedUp",i)}}]),e}(),ie=function(){function e(t,r,n){V(this,e),this._dispatcher=t,this._apiModule=r,this._UserModel=n}return ee(e,[{key:"logout",value:function(){var e=this;this._apiModule.logout().then(function(){e._dispatcher.dispatchEvent("User",null),e._dispatcher.dispatchEvent("LoggedOut","success")}).catch(function(t){console.log(t),e._dispatcher.dispatchEvent("LoggedOut",t)})}}]),e}(),se=function(){function e(t,r,n,o){V(this,e),this._dispatcher=t,this._apiModule=r,this._validator=n,this._UserModel=o}return ee(e,[{key:"updateProfile",value:function(e,t,r,n){var o=this,i=this._validator.validateUpdate(e,t,r);if(null===i.error){if(this._apiModule.updateUserInfo(e,t).then(function(e){var t=e.avatar||null;o._dispatcher.dispatchEvent("User",new o._UserModel(e.email,e.login,e.score,t)),o._dispatcher.dispatchEvent("ProfileUpdated","success")}).catch(function(e){if("string"==typeof e)console.log(e);else{var t={error:(e=e.payload).message,errorField:e.field};o._dispatcher.dispatchEvent("ProfileUpdated",t)}}),n.value){var s=new FormData;s.append("avatar",n.files[0]),this._apiModule.uploadAvatar(s).then(function(e){var t=e.avatar||null;o._dispatcher.dispatchEvent("User",new o._UserModel(e.email,e.login,e.score,t)),o._dispatcher.dispatchEvent("AvatarUpdated","success")}).catch(function(e){if("string"==typeof e)console.log(e);else{var t={error:(e=e.payload).message,errorField:e.field};o._dispatcher.dispatchEvent("AvatarUpdated",t)}})}}else this._dispatcher.dispatchEvent("ProfileUpdated",i)}}]),e}(),ae=function(){function e(t,r){var n=this;V(this,e),this._dispatcher=t,this._apiModule=r,this._socket=new WebSocket("wss://chat.kpacubo.xyz:2000/ws"),this._socket.onopen=function(){console.log("Соединение установлено.")},this._socket.onclose=function(e){e.wasClean?console.log("Соединение закрыто чисто"):console.log("Обрыв соединения"),console.log("Код: "+e.code+" причина: "+e.reason)},this._socket.onmessage=function(e){var t=JSON.parse(e.data);""!==t.uid?n._apiModule.getUserById(t.uid).then(function(e){n._dispatcher.dispatchEvent("Msg",{text:e.login+":"+t.text,avatar:e.avatar||"public/img/avatar.jpg"})}):n._dispatcher.dispatchEvent("Msg",{text:"anon:"+t.text,avatar:"public/img/avatar.jpg"})},this._socket.onerror=function(e){console.log("Ошибка "+e.message)}}return ee(e,[{key:"sendMsg",value:function(e){this._socket.send(JSON.stringify({text:e}))}},{key:"loadHistory",value:function(){var e=this;this._apiModule.getChatHistory().then(function(t){t=t.reverse(),e._dispatcher.dispatchEvent("Msgs",t),console.log(t)}).catch(function(e){console.log(e)})}},{key:"getLogin",value:function(){return this._apiModule.getUserInfo()}}]),e}(),ue=new Y({apiModule:N,validator:D,UserModel:z,dispatcher:S});ue.addConstructor(te,["dispatcher","apiModule"]),ue.addConstructor(re,["dispatcher","apiModule","validator","UserModel"]),ue.addConstructor(ne,["dispatcher","apiModule","UserModel"]),ue.addConstructor(oe,["dispatcher","apiModule","validator","UserModel"]),ue.addConstructor(ie,["dispatcher","apiModule","UserModel"]),ue.addConstructor(se,["dispatcher","apiModule","validator","UserModel"]),ue.addConstructor(K,["dispatcher","apiModule","UserModel"]),ue.addConstructor(ae,["dispatcher","apiModule"]);var le=ue.getFabricator(te)(),ce=ue.getFabricator(re)(),de=ue.getFabricator(ne)(),he=ue.getFabricator(oe)(),fe=ue.getFabricator(ie)(),pe=ue.getFabricator(se)(),ve=ue.getFabricator(K)(),ge=ue.getFabricator(ae)();function ye(e,t,r){r.addRoute("/",e.getFabricator(y)),r.addRoute("/login",e.getFabricator(_)),r.addRoute("/profile",e.getFabricator(m)),r.addRoute("/settings",e.getFabricator(b)),r.addRoute("/signup",e.getFabricator(E)),r.addRoute("/leaderboard",e.getFabricator(w)),r.addRoute("/about",e.getFabricator(k)),r.addRoute("/logout",e.getFabricator(L)),r.addRoute("/singleplayer",e.getFabricator(M)),r.addRoute("/chat",e.getFabricator(T)),r.notFoundRouteMaker=e.newNotFoundRoute;var n=function(){var e=window.location.href,t=e.indexOf("//"),r=e.slice(t+2),n=r.indexOf("/");return r=r.slice(n)}();r.setDefaultRoute(n),r.init(),function(e,t){e instanceof Node&&t instanceof s&&(e.addEventListener("click",function(e){if(e.target instanceof HTMLAnchorElement){e.preventDefault();var r=e.target.getAttribute("href");t.routeTo(r),console.log("<a> go to ".concat(r))}}),window.addEventListener("popstate",function(){console.log(location.pathname),t.routeTo(location.pathname,!1)},!1))}(t,r)}"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("sw.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})}),window.onload=function(){var e=document.getElementById("root"),t=new s(e);ye(function(){var e=new Y({subscriber:x});return e.addConstructor(y,["rootEl","router","controller","subscriber","loginController","signupController"],{factoryArgs:["rootEl","router"],injections:{controller:de,loginController:ce,signupController:he}}),e.addConstructor(_,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:ce}}),e.addConstructor(m,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:de}}),e.addConstructor(b,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:pe}}),e.addConstructor(E,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:he}}),e.addConstructor(w,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:le}}),e.addConstructor(k,["rootEl","router"],{factoryArgs:["rootEl","router"]}),e.addConstructor(T,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:ge}}),e.addConstructor(L,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:fe}}),e.addConstructor(M,["rootEl","router","controller","subscriber"],{factoryArgs:["rootEl","router"],injections:{controller:ve}}),e.addConstructor(U,["rootEl","router"],{factoryArgs:["rootEl","router"]}),e}(),e,t),window.addEventListener("fetch",function(e){console.log(e)})}}]);